<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCP Security - Detection Engineering Mastery</title>
    <link rel="stylesheet" href="../../css/main.css">
</head>
<body>
    <div class="layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="../../index.html" class="logo">
                    <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                    <span>Detection Engineering</span>
                </a>
            </div>
            <div class="nav-sections">
                <div class="nav-section " data-section="detection-engineering">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                            <span>Detection Engineering</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../detection-engineering/fundamentals.html" class="nav-item ">Detection Fundamentals</a>
                        <a href="../detection-engineering/sentinel-deep-dive.html" class="nav-item ">Microsoft Sentinel</a>
                        <a href="../detection-engineering/splunk-comparison.html" class="nav-item ">Splunk Comparison</a>
                        <a href="../detection-engineering/detection-logic.html" class="nav-item ">Detection Logic</a>
                        <a href="../detection-engineering/mitre-mapping.html" class="nav-item ">MITRE ATT&CK Mapping</a>
                        <a href="../detection-engineering/use-case-framework.html" class="nav-item ">Use Case Framework</a>
                        <a href="../detection-engineering/metrics-optimization.html" class="nav-item ">Metrics & Optimization</a>
                    </div>
                </div>
                <div class="nav-section " data-section="log-analysis">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Log Analysis</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../log-analysis/fundamentals.html" class="nav-item ">Log Fundamentals</a>
                        <a href="../log-analysis/network-logs.html" class="nav-item ">Network Logs</a>
                        <a href="../log-analysis/endpoint-logs.html" class="nav-item ">Endpoint Logs</a>
                        <a href="../log-analysis/cloud-logs.html" class="nav-item ">Cloud Logs</a>
                        <a href="../log-analysis/identity-logs.html" class="nav-item ">Identity Logs</a>
                        <a href="../log-analysis/data-models.html" class="nav-item ">Data Models</a>
                    </div>
                </div>
                <div class="nav-section " data-section="threat-intel">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            <span>Threat Intelligence</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../threat-intel/fundamentals.html" class="nav-item ">TI Fundamentals</a>
                        <a href="../threat-intel/sources.html" class="nav-item ">Intelligence Sources</a>
                        <a href="../threat-intel/ioc-management.html" class="nav-item ">IOC Management</a>
                        <a href="../threat-intel/threat-hunting.html" class="nav-item ">Threat Hunting</a>
                        <a href="../threat-intel/hunting-methodology.html" class="nav-item ">Hunting Methodology</a>
                        <a href="../threat-intel/hunting-techniques.html" class="nav-item ">Hunting Techniques</a>
                        <a href="../threat-intel/hunting-queries.html" class="nav-item ">Hunting Queries</a>
                        <a href="../threat-intel/mitre-framework.html" class="nav-item ">MITRE Deep Dive</a>
                    </div>
                </div>
                <div class="nav-section " data-section="sap-security">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                            <span>SAP Security</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../sap-security/sap-overview.html" class="nav-item ">SAP Overview</a>
                        <a href="../sap-security/architecture.html" class="nav-item ">Architecture</a>
                        <a href="../sap-security/modules-services.html" class="nav-item ">Modules & Services</a>
                        <a href="../sap-security/security-fundamentals.html" class="nav-item ">Security Fundamentals</a>
                        <a href="../sap-security/log-types.html" class="nav-item ">Log Types</a>
                        <a href="../sap-security/threat-detection.html" class="nav-item ">Threat Detection</a>
                        <a href="../sap-security/siem-integration.html" class="nav-item ">SIEM Integration</a>
                        <a href="../sap-security/compliance.html" class="nav-item ">Compliance</a>
                    </div>
                </div>
                <div class="nav-section " data-section="vulnerability-mgmt">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            <span>Vulnerability Management</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../vulnerability-mgmt/fundamentals.html" class="nav-item ">VM Fundamentals</a>
                        <a href="../vulnerability-mgmt/scanning.html" class="nav-item ">Scanning</a>
                        <a href="../vulnerability-mgmt/qualys-deep-dive.html" class="nav-item ">Qualys Deep Dive</a>
                        <a href="../vulnerability-mgmt/tenable.html" class="nav-item ">Tenable/Nessus</a>
                        <a href="../vulnerability-mgmt/prioritization.html" class="nav-item ">Prioritization</a>
                        <a href="../vulnerability-mgmt/remediation.html" class="nav-item ">Remediation</a>
                        <a href="../vulnerability-mgmt/metrics.html" class="nav-item ">VM Metrics</a>
                        <a href="../vulnerability-mgmt/automation.html" class="nav-item ">VM Automation</a>
                    </div>
                </div>
                <div class="nav-section expanded" data-section="cloud-security">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
                            <span>Cloud Security</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../cloud-security/fundamentals.html" class="nav-item ">Cloud Fundamentals</a>
                        <a href="../cloud-security/aws-security.html" class="nav-item ">AWS Security</a>
                        <a href="../cloud-security/azure-security.html" class="nav-item ">Azure Security</a>
                        <a href="../cloud-security/gcp-security.html" class="nav-item active">GCP Security</a>
                        <a href="../cloud-security/multi-cloud.html" class="nav-item ">Multi-Cloud</a>
                        <a href="../cloud-security/cspm.html" class="nav-item ">CSPM & CWPP</a>
                    </div>
                </div>
                <div class="nav-section " data-section="automation">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                            <span>Automation</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../automation/fundamentals.html" class="nav-item ">Automation Fundamentals</a>
                        <a href="../automation/python-security.html" class="nav-item ">Python for Security</a>
                        <a href="../automation/powershell-security.html" class="nav-item ">PowerShell</a>
                        <a href="../automation/bash-security.html" class="nav-item ">Bash Scripting</a>
                        <a href="../automation/soar.html" class="nav-item ">SOAR Platforms</a>
                        <a href="../automation/api-integration.html" class="nav-item ">API Integration</a>
                    </div>
                </div>
                <div class="nav-section " data-section="compliance">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span>Compliance</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../compliance/framework-overview.html" class="nav-item ">Framework Overview</a>
                        <a href="../compliance/iso-27001.html" class="nav-item ">ISO 27001</a>
                        <a href="../compliance/nist-csf.html" class="nav-item ">NIST CSF</a>
                        <a href="../compliance/nist-800-53.html" class="nav-item ">NIST 800-53</a>
                        <a href="../compliance/gdpr.html" class="nav-item ">GDPR</a>
                        <a href="../compliance/other-frameworks.html" class="nav-item ">Other Frameworks</a>
                        <a href="../compliance/documentation.html" class="nav-item ">Documentation</a>
                    </div>
                </div>
                <div class="nav-section " data-section="incident-response">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                            <span>Incident Response</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../incident-response/soc-collaboration.html" class="nav-item ">SOC Collaboration</a>
                        <a href="../incident-response/ir-support.html" class="nav-item ">IR Support</a>
                        <a href="../incident-response/forensics.html" class="nav-item ">Forensics</a>
                        <a href="../incident-response/communication.html" class="nav-item ">Communication</a>
                    </div>
                </div>
                <div class="nav-section " data-section="references">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                            <span>Quick Reference</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <div class="nav-items">
                        <a href="../references/kql-cheatsheet.html" class="nav-item ">KQL Cheatsheet</a>
                        <a href="../references/spl-cheatsheet.html" class="nav-item ">SPL Cheatsheet</a>
                        <a href="../references/regex-mastery.html" class="nav-item ">Regex Reference</a>
                        <a href="../references/windows-events.html" class="nav-item ">Windows Events</a>
                        <a href="../references/mitre-quick-ref.html" class="nav-item ">MITRE Quick Ref</a>
                        <a href="../references/interview-prep.html" class="nav-item ">Interview Prep</a>
                        <a href="../references/interview-answers.html" class="nav-item ">My Interview Answers</a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content">
                <nav class="breadcrumb">
                    <a href="../../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="gcp-security.html">Cloud Security</a>
                    <span class="separator">/</span>
                    <span class="current">GCP Security</span>
                </nav>

                <header class="page-header">
                    <h1>GCP Security</h1>
                    <p class="subtitle">Comprehensive GCP security monitoring with Cloud Audit Logs, Security Command Center, and detection engineering for Google Cloud environments.</p>
                </header>

                <section class="content-section">
                    <h2>GCP Security Architecture</h2>
                    
                    <div class="grid-2">
                        <div class="info-box">
                            <h4>ğŸ“Š Detection & Monitoring</h4>
                            <ul>
                                <li><strong>Cloud Audit Logs</strong> - API activity logging</li>
                                <li><strong>Cloud Logging</strong> - Centralized log management</li>
                                <li><strong>Security Command Center</strong> - Threat detection</li>
                                <li><strong>Chronicle SIEM</strong> - Google's security analytics</li>
                                <li><strong>Event Threat Detection</strong> - Built-in detections</li>
                            </ul>
                        </div>
                        <div class="info-box">
                            <h4>ğŸ›¡ï¸ Preventive Controls</h4>
                            <ul>
                                <li><strong>Cloud IAM</strong> - Identity & access</li>
                                <li><strong>Organization Policies</strong> - Guardrails</li>
                                <li><strong>VPC Service Controls</strong> - Data exfiltration prevention</li>
                                <li><strong>Cloud Armor</strong> - DDoS & WAF</li>
                                <li><strong>Secret Manager</strong> - Secrets management</li>
                            </ul>
                        </div>
                    </div>

                    <h3>GCP Resource Hierarchy</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>GCP Resource Hierarchy</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Organization (domain.com)                     â”‚
â”‚      Organization Policies | IAM Policies | Audit Config         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Folder     â”‚    â”‚    Folder     â”‚    â”‚    Folder     â”‚
â”‚  (Production) â”‚    â”‚  (Staging)    â”‚    â”‚   (Shared)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Project     â”‚    â”‚   Project     â”‚    â”‚   Project     â”‚
â”‚  (prod-app)   â”‚    â”‚  (stage-app)  â”‚    â”‚  (logging)    â”‚
â”‚ GCE,GCS,SQL   â”‚    â”‚  GKE,Run      â”‚    â”‚ BigQuery,Sink â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
                    </div>
                </section>

                <section class="content-section">
                    <h2>Cloud Audit Logs Deep Dive</h2>
                    
                    <h3>Audit Log Types</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Log Type</th>
                                <th>Contents</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Admin Activity</strong></td>
                                <td>Resource configuration changes (create, delete, update)</td>
                                <td>Always enabled, free</td>
                            </tr>
                            <tr>
                                <td><strong>Data Access</strong></td>
                                <td>Data reads/writes (BigQuery queries, GCS access)</td>
                                <td>Disabled by default, charged</td>
                            </tr>
                            <tr>
                                <td><strong>System Event</strong></td>
                                <td>GCP system actions (live migration, maintenance)</td>
                                <td>Always enabled, free</td>
                            </tr>
                            <tr>
                                <td><strong>Policy Denied</strong></td>
                                <td>VPC Service Control violations</td>
                                <td>Always enabled when VPC-SC used</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Audit Log Structure</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>Cloud Audit Log JSON</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>{
    "protoPayload": {
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog",
        "authenticationInfo": {
            "principalEmail": "admin@company.com"
        },
        "requestMetadata": {
            "callerIp": "198.51.100.50",
            "callerSuppliedUserAgent": "gcloud/450.0.0"
        },
        "serviceName": "iam.googleapis.com",
        "methodName": "google.iam.admin.v1.CreateServiceAccountKey",
        "authorizationInfo": [{
            "permission": "iam.serviceAccountKeys.create",
            "granted": true
        }],
        "resourceName": "projects/-/serviceAccounts/my-sa@project.iam.gserviceaccount.com"
    },
    "resource": {
        "type": "service_account",
        "labels": { "project_id": "my-project" }
    },
    "timestamp": "2024-01-15T10:30:00.000Z",
    "severity": "NOTICE"
}</code></pre>
                    </div>
                </section>

                <section class="content-section">
                    <h2>Critical GCP Detections</h2>

                    <div class="info-box warning">
                        <h4>âš ï¸ MITRE ATT&CK: T1078.004 - Valid Accounts: Cloud Accounts</h4>
                        <p>Service account key theft and IAM privilege escalation are primary attack vectors in GCP.</p>
                    </div>

                    <h3>Detection: Service Account Key Creation</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>BigQuery SQL - SA Key Creation</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>SELECT
    timestamp,
    protopayload_auditlog.authenticationInfo.principalEmail AS actor,
    protopayload_auditlog.requestMetadata.callerIp AS source_ip,
    protopayload_auditlog.resourceName AS service_account,
    resource.labels.project_id AS project
FROM `project.dataset.cloudaudit_googleapis_com_activity_*`
WHERE _TABLE_SUFFIX >= FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
    AND protopayload_auditlog.methodName = 'google.iam.admin.v1.CreateServiceAccountKey'
    -- Alert: Keys created by humans (not automation)
    AND protopayload_auditlog.authenticationInfo.principalEmail NOT LIKE '%gserviceaccount.com'
ORDER BY timestamp DESC</code></pre>
                    </div>

                    <h3>Detection: Privileged Role Grant</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>BigQuery SQL - High Privilege IAM Assignment</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>WITH privileged_roles AS (
    SELECT role FROM UNNEST([
        'roles/owner', 'roles/editor', 'roles/iam.securityAdmin',
        'roles/iam.serviceAccountAdmin', 'roles/resourcemanager.organizationAdmin'
    ]) AS role
)
SELECT
    timestamp,
    protopayload_auditlog.authenticationInfo.principalEmail AS granting_user,
    JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
        '$.policyDelta.bindingDeltas[0].member') AS target_member,
    JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
        '$.policyDelta.bindingDeltas[0].role') AS granted_role,
    resource.labels.project_id AS target_project
FROM `project.dataset.cloudaudit_googleapis_com_activity_*`
WHERE _TABLE_SUFFIX >= FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
    AND protopayload_auditlog.methodName = 'SetIamPolicy'
    AND JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
        '$.policyDelta.bindingDeltas[0].action') = 'ADD'
    AND JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
        '$.policyDelta.bindingDeltas[0].role') IN (SELECT role FROM privileged_roles)</code></pre>
                    </div>

                    <h3>Detection: Logging Configuration Tampering</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>BigQuery SQL - Log Sink Deletion</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>SELECT
    timestamp,
    protopayload_auditlog.authenticationInfo.principalEmail AS actor,
    protopayload_auditlog.methodName AS action,
    protopayload_auditlog.resourceName AS target_resource,
    resource.labels.project_id AS project
FROM `project.dataset.cloudaudit_googleapis_com_activity_*`
WHERE _TABLE_SUFFIX >= FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
    AND protopayload_auditlog.serviceName = 'logging.googleapis.com'
    AND protopayload_auditlog.methodName IN (
        'google.logging.v2.ConfigServiceV2.DeleteSink',
        'google.logging.v2.ConfigServiceV2.CreateExclusion'
    )
-- MITRE: T1562.008 - Impair Defenses: Disable Cloud Logs</code></pre>
                    </div>

                    <h3>Detection: GCS Bucket Made Public</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>BigQuery SQL - Public Storage Access</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>SELECT
    timestamp,
    protopayload_auditlog.authenticationInfo.principalEmail AS actor,
    protopayload_auditlog.resourceName AS bucket,
    JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
        '$.policyDelta.bindingDeltas[0].member') AS granted_to,
    resource.labels.project_id AS project
FROM `project.dataset.cloudaudit_googleapis_com_activity_*`
WHERE _TABLE_SUFFIX >= FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
    AND protopayload_auditlog.serviceName = 'storage.googleapis.com'
    AND protopayload_auditlog.methodName = 'storage.setIamPermissions'
    AND (
        JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
            '$.policyDelta.bindingDeltas[0].member') = 'allUsers'
        OR JSON_EXTRACT_SCALAR(protopayload_auditlog.serviceData, 
            '$.policyDelta.bindingDeltas[0].member') = 'allAuthenticatedUsers'
    )
-- MITRE: T1530 - Data from Cloud Storage Object</code></pre>
                    </div>

                    <h3>Detection: Firewall Rules 0.0.0.0/0</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>BigQuery SQL - Unrestricted Firewall</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>SELECT
    timestamp,
    protopayload_auditlog.authenticationInfo.principalEmail AS actor,
    JSON_EXTRACT_SCALAR(protopayload_auditlog.request, '$.name') AS firewall_rule,
    JSON_EXTRACT(protopayload_auditlog.request, '$.sourceRanges') AS source_ranges,
    JSON_EXTRACT(protopayload_auditlog.request, '$.allowed') AS allowed_ports,
    resource.labels.project_id AS project
FROM `project.dataset.cloudaudit_googleapis_com_activity_*`
WHERE _TABLE_SUFFIX >= FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
    AND protopayload_auditlog.serviceName = 'compute.googleapis.com'
    AND protopayload_auditlog.methodName IN (
        'v1.compute.firewalls.insert', 'v1.compute.firewalls.update'
    )
    AND JSON_EXTRACT(protopayload_auditlog.request, '$.sourceRanges') LIKE '%0.0.0.0/0%'</code></pre>
                    </div>
                </section>

                <section class="content-section">
                    <h2>Security Command Center</h2>

                    <h3>SCC Capabilities</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Standard</th>
                                <th>Premium</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Security Health Analytics</strong></td>
                                <td>Basic misconfigs</td>
                                <td>Full detection</td>
                            </tr>
                            <tr>
                                <td><strong>Event Threat Detection</strong></td>
                                <td>âœ—</td>
                                <td>âœ“ Real-time threats</td>
                            </tr>
                            <tr>
                                <td><strong>Container Threat Detection</strong></td>
                                <td>âœ—</td>
                                <td>âœ“ GKE runtime</td>
                            </tr>
                            <tr>
                                <td><strong>VM Threat Detection</strong></td>
                                <td>âœ—</td>
                                <td>âœ“ Cryptomining</td>
                            </tr>
                            <tr>
                                <td><strong>Compliance</strong></td>
                                <td>Limited</td>
                                <td>CIS, PCI, ISO</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box danger">
                        <h4>ğŸš¨ Critical SCC Findings</h4>
                        <ul>
                            <li><strong>CRYPTOMINING_RUNNING_PROCESS</strong> - Active cryptominer</li>
                            <li><strong>MALWARE_DETECTED</strong> - Malicious software</li>
                            <li><strong>EXFILTRATION_TO_EXTERNAL_STORAGE</strong> - Data leaving org</li>
                            <li><strong>ANOMALOUS_SERVICE_ACCOUNT_ACCESS</strong> - Unusual SA activity</li>
                            <li><strong>PUBLIC_BUCKET_ACL</strong> - Storage exposed</li>
                        </ul>
                    </div>

                    <h3>Python - Query SCC Findings</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span>SCC API Integration</span>
                            <button class="copy-btn">Copy</button>
                        </div>
                        <pre><code>from google.cloud import securitycenter_v1
from datetime import datetime, timedelta

def list_high_severity_findings(organization_id: str, hours: int = 24):
    client = securitycenter_v1.SecurityCenterClient()
    parent = f"organizations/{organization_id}/sources/-"
    
    start_time = datetime.utcnow() - timedelta(hours=hours)
    finding_filter = f'''
        (severity = "HIGH" OR severity = "CRITICAL") 
        AND state = "ACTIVE"
        AND event_time >= "{start_time.isoformat()}Z"
    '''
    
    findings = client.list_findings(
        request={"parent": parent, "filter": finding_filter}
    )
    
    for result in findings:
        f = result.finding
        print(f"{f.category} - {f.severity.name}")
        print(f"  Resource: {f.resource_name}")
        print(f"  Time: {f.event_time}")</code></pre>
                    </div>
                </section>

                <section class="content-section">
                    <h2>GCP Detection Best Practices</h2>

                    <div class="info-box tip">
                        <h4>ğŸ’¡ Logging Configuration Checklist</h4>
                        <ul>
                            <li>Enable Data Access logs for sensitive services (BigQuery, GCS, Secret Manager)</li>
                            <li>Create organization-level log sinks to centralized project</li>
                            <li>Export logs to BigQuery for long-term analysis</li>
                            <li>Enable Security Command Center Premium</li>
                            <li>Configure VPC Flow Logs for network visibility</li>
                        </ul>
                    </div>

                    <h3>Detection Coverage Matrix</h3>
                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <h4>Must-Have Detections</h4>
                            <ul>
                                <li>âœ… SA key creation</li>
                                <li>âœ… Privileged role grants</li>
                                <li>âœ… Public bucket/object ACLs</li>
                                <li>âœ… Firewall 0.0.0.0/0</li>
                                <li>âœ… Log sink deletion</li>
                                <li>âœ… SCC critical findings</li>
                            </ul>
                        </div>
                        <div class="comparison-card">
                            <h4>Advanced Detections</h4>
                            <ul>
                                <li>ğŸ” SA token external usage</li>
                                <li>ğŸ” Cross-project access</li>
                                <li>ğŸ” Cloud Function backdoors</li>
                                <li>ğŸ” BigQuery data export</li>
                                <li>ğŸ” GKE privileged containers</li>
                                <li>ğŸ” Secret Manager anomalies</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="content-section">
                    <h2>Interview Preparation</h2>
                    
                    <div class="expandable">
                        <button class="expandable-header">
                            <span>Q: What's the difference between Admin Activity and Data Access logs?</span>
                            <span class="expand-icon">+</span>
                        </button>
                        <div class="expandable-content">
                            <p><strong>Admin Activity logs</strong> capture control plane operations that modify configuration. Creating a VM, changing IAM, modifying bucketsâ€”always on, free, cannot disable.</p>
                            <p><strong>Data Access logs</strong> capture data plane operations reading/writing user data. GCS reads, BigQuery queriesâ€”disabled by default, incur costs due to volume.</p>
                            <p><strong>Detection:</strong> Admin Activity is essential for security monitoring. Enable Data Access selectively for sensitive resources (critical GCS, BigQuery with PII, Secret Manager).</p>
                        </div>
                    </div>

                    <div class="expandable">
                        <button class="expandable-header">
                            <span>Q: How would you detect compromised service account keys?</span>
                            <span class="expand-icon">+</span>
                        </button>
                        <div class="expandable-content">
                            <p><strong>Detection indicators:</strong></p>
                            <ul>
                                <li>API calls from external IPs (not GCP internal)</li>
                                <li>Activity from unexpected regions</li>
                                <li>Unusual API methods for that SA's purpose</li>
                                <li>High volume of reconnaissance calls</li>
                                <li>SCC findings for anomalous SA activity</li>
                            </ul>
                            <p><strong>Response:</strong> Disable key (don't delete), review all Admin Activity logs, check for persistence (new keys, IAM changes), assess data access, consider migrating to workload identity.</p>
                        </div>
                    </div>

                    <div class="expandable">
                        <button class="expandable-header">
                            <span>Q: What is VPC Service Controls and why important for detection?</span>
                            <span class="expand-icon">+</span>
                        </button>
                        <div class="expandable-content">
                            <p><strong>VPC Service Controls</strong> creates security perimeters preventing data exfiltration even with valid credentials. Restricts access based on IP, device state, identity.</p>
                            <p><strong>Detection value:</strong> Policy Denied logs capture blocked attempts. Repeated violations may indicate compromise. VPC-SC is preventive, but its logs detect attack attempts that would otherwise succeed.</p>
                        </div>
                    </div>
                </section>

                <nav class="page-nav">
                    <a href="azure-security.html" class="nav-link prev">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Azure Security
                    </a>
                    <a href="multi-cloud.html" class="nav-link next">
                        Multi-Cloud Strategy
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </a>
                </nav>
            </div>
        </main>
    </div>
    <script src="../../js/sidebar.js"></script>
</body>
</html>